<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technician Dashboard - FixMate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="tech.css">
</head>
<body>

<div class="mobile-toggle" id="mobileToggle">
    <i class="fas fa-bars"></i>
</div>

<aside class="sidebar" id="sidebar">
    <div class="logo">
        <h2>Fix<span style="color:#a5d6a7;">MATE</span></h2>
        <p>Technician Portal</p>
    </div>

    <div class="nav-menu">
        <div class="nav-item active">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
        </div>

        <div class="nav-item" onclick="logout()" style="cursor:pointer; color:#ff7675;">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>
</aside>

<main class="main-content">

    <div class="header">
        <h1 id="welcomeTitle">Welcome</h1>
    </div>

    <div class="summary-cards">
        <div class="card">
            <div class="card-title">Total Tasks</div>
            <div class="card-value" id="stat-total">0</div>
        </div>
        <div class="card">
            <div class="card-title">In Progress</div>
            <div class="card-value" id="stat-inprogress">0</div>
        </div>
        <div class="card">
            <div class="card-title">Completed</div>
            <div class="card-value" id="stat-completed">0</div>
        </div>
    </div>

    <div class="dashboard-layout">
        <div class="task-list-section">
            <h2>My Assigned Tasks</h2>
            <div id="taskList"></div>
        </div>

        <div class="task-detail-section">
            <h2>Task Details</h2>
            <div id="taskDetailCard">
                <p>Select a task to update status</p>
            </div>
        </div>

    </div>
</main>

<script>
let tasks = [];
const technicianName = localStorage.getItem('userName');
const role = localStorage.getItem('userRole');

document.addEventListener('DOMContentLoaded', () => {
    if (!technicianName || role !== 'Technician') {
        window.location.href = 'login.html';
        return;
    }

    document.getElementById('welcomeTitle').innerText =
        `Welcome back, ${technicianName}`;

    fetchTasks();
    setupMobileMenu();
});


async function fetchTasks() {
    const res = await fetch(
        `http://localhost:3000/api/tech-tasks/${encodeURIComponent(technicianName)}`
    );
    tasks = await res.json();
    renderTaskList(tasks);
    updateStats(tasks);
}


function renderTaskList(data) {
    const list = document.getElementById('taskList');
    list.innerHTML = '';

    if (data.length === 0) {
        list.innerHTML = '<p>No tasks assigned.</p>';
        return;
    }

    data.forEach(task => {
        const div = document.createElement('div');
        div.className = 'task-item';
        div.innerHTML = `
            <strong>#${task.id}</strong> - ${task.asset_name}<br>
            Status: <b>${task.status}</b>
        `;
        div.onclick = () => showTaskDetails(task.id);
        list.appendChild(div);
    });
}


function showTaskDetails(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    document.getElementById('taskDetailCard').innerHTML = `
        <h3>Task #${task.id}</h3>

        <p><b>Asset:</b> ${task.asset_name}</p>
        <p><b>Location:</b> ${task.location}</p>

        <p><b>Description:</b></p>
        <p style="background:#f4f4f4; padding:10px; border-radius:5px;">
            ${task.description}
        </p>

        <label><b>Update Status</b></label>
        <select id="statusSelector" style="width:100%; padding:10px;">
            <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>
                In Progress
            </option>
            <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>
                Completed
            </option>
        </select>

        <button onclick="updateStatus(${task.id})">
            Update Status
        </button>
    `;
}

async function updateStatus(taskId) {
    const status = document.getElementById('statusSelector').value;

    const res = await fetch('http://localhost:3000/api/update-status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            task_id: taskId,
            status: status
        })
    });

    if (res.ok) {
        alert('Status updated successfully');
        fetchTasks();
    }
}

function updateStats(data) {
    document.getElementById('stat-total').innerText = data.length;
    document.getElementById('stat-inprogress').innerText =
        data.filter(t => t.status === 'In Progress').length;
    document.getElementById('stat-completed').innerText =
        data.filter(t => t.status === 'Completed').length;
}


function setupMobileMenu() {
    const toggle = document.getElementById('mobileToggle');
    const sidebar = document.getElementById('sidebar');
    toggle.onclick = () => sidebar.classList.toggle('active');
}

function logout() {
    localStorage.clear();
    window.location.href = 'login.html';
}
</script>

</body>
</html>
