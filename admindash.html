<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - FixMate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin.css">

    <style>
        .user-profile {
            text-transform: uppercase;
            font-weight: bold;
            font-size: 30px;
        }
        .table-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:12px; border-bottom:1px solid #eee; }
        th { background:#f8f9fa; }

        .btn-approve {
            background:#34645a;
            color:white;
            border:none;
            padding:8px 14px;
            border-radius:4px;
            cursor:pointer;
        }
        .btn-approve:hover { background:#3c755f; }

        .modal {
            display:none;
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.6);
            z-index:2000;
        }
        .modal-content {
            background:white;
            width:420px;
            margin:8% auto;
            padding:25px;
            border-radius:8px;
        }
    </style>
</head>

<body>

<aside class="sidebar">
    <div class="logo">
        <h2>Fix<span style="color:#a5d6a7;">MATE</span></h2>
        <p>Administrator</p>
    </div>
    <nav class="nav-menu">
        <div class="nav-item" onclick="window.location.href='admindash.html'">
            <i class="fas fa-home"></i> Dashboard</div>
        <div class="nav-item" onclick="window.location.href='assets.html'">
            <i class="fas fa-boxes"></i> Assets
        </div>
        <div class="nav-item" onclick="logout()" style="color:#ff7675;cursor:pointer;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </div>
    </nav>
</aside>

<main class="main-content">
<header class="header">
    <h1>System Overview</h1>
    <div class="user-profile">
        <span id="adminName"><h1>Admin</h1></span>
    </div>
</header>

<div class="table-card">
    <h3><i class="fas fa-inbox"></i> Employee Request Inbox</h3>
    <table>
        <thead>
            <tr>
                <th>Employee</th>
                <th>Issue</th>
                <th>Location</th>
                <th>Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="requestInboxBody"></tbody>
    </table>
</div>


<div class="table-card">
    <h3><i class="fas fa-tools"></i> Active Maintenance Tasks</h3>
    <table>
        <thead>
            <tr>
                <th>Asset</th>
                <th>Technician</th>
                <th>Deadline</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="activeTasksBody"></tbody>
    </table>
</div>


<div class="table-card">
    <h3><i class="fas fa-boxes"></i> Asset Management</h3>
    <table>
        <thead>
            <tr>
                <th>Asset</th>
                <th>Type</th>
                <th>Location</th>
                <th>Status</th>
                <th>Next Maintenance</th>
            </tr>
        </thead>
        <tbody id="assetTableBody"></tbody>
    </table>
</div>

</main>

<div class="modal" id="approveRequestModal">
<div class="modal-content">
    <h3>Approve & Assign Technician</h3>
    <hr><br>

    <p id="displayIssueTitle" style="font-weight:bold;color:#34645a;"></p>

    <form id="approvalForm">
        <input type="hidden" id="targetRequestId">

        <label>Assign Technician</label>
        <select id="techSelect" required style="width:100%;padding:10px;margin-bottom:15px;"></select>

        <label>Priority</label>
        <select id="prioritySelect" style="width:100%;padding:10px;margin-bottom:15px;">
            <option>Low</option>
            <option selected>Medium</option>
            <option>High</option>
            <option>Critical</option>
        </select>

        <label>Deadline</label>
        <input type="date" id="deadlineInput" required style="width:100%;padding:10px;margin-bottom:20px;">

        <button type="submit" class="btn-approve" style="width:100%;">
            Create Task & Notify Technician
        </button>

        <button type="button" onclick="closeModal()" style="width:100%;margin-top:10px;border:none;background:none;">
            Cancel
        </button>
    </form>
</div>
</div>

<script>
    if (localStorage.getItem("userRole") !== "Admin") {
        alert("Unauthorized");
        window.location.href = "adminlogin.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("adminName").innerText = localStorage.getItem("userName");
        loadInbox();
        loadActiveTasks();
        loadTechnicians();
        loadAssets();
    });


    async function loadInbox() {
        const res = await fetch("http://localhost:3000/api/employee-requests");
        const data = await res.json();
        const body = document.getElementById("requestInboxBody");

        body.innerHTML = data.length ? data.map(r => `
            <tr>
                <td>${r.employee_name}</td>
                <td><b>${r.title}</b></td>
                <td>${r.location}</td>
                <td>${new Date(r.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn-approve"
                        onclick="openApprovalModal(${r.request_id}, ${r.asset_id}, '${r.title}')">
                        Review & Approve
                    </button>
                </td>
            </tr>
        `).join("") : `<tr><td colspan="5">No pending requests</td></tr>`;
    }

    function openApprovalModal(id, assetId, title) {
        document.getElementById("targetRequestId").value = id;
        document.getElementById("displayIssueTitle").innerText = title;
        document.getElementById("approveRequestModal").style.display = "block";
        window.selectedAssetId = assetId;
    }

    const payload = {
        request_id: document.getElementById("targetRequestId").value,
        asset_id: window.selectedAssetId,
        technician_name: techSelect.value,
        priority: prioritySelect.value,
        deadline: deadlineInput.value
    };


    function closeModal() {
        document.getElementById("approveRequestModal").style.display = "none";
    }


    document.getElementById("approvalForm").onsubmit = async e => {
    e.preventDefault();

    const payload = {
        request_id: document.getElementById("targetRequestId").value,
        technician_name: techSelect.value,
        priority: prioritySelect.value,
        deadline: deadlineInput.value,
    };

        const res = await fetch("http://localhost:3000/api/approve-request", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify(payload)
        });

        if (res.ok) {
            alert("Task Assigned Successfully!");
            closeModal();
            loadInbox();
            loadActiveTasks();
        }
    };

    async function loadActiveTasks() {
        const res = await fetch("http://localhost:3000/api/all-tasks");
        const data = await res.json();
        activeTasksBody.innerHTML = data.map(t => `
            <tr>
                <td>${t.asset_name}</td>
                <td>${t.technician_name}</td>
                <td>${new Date(t.deadline).toLocaleDateString()}</td>
                <td>${t.status}</td>
            </tr>
        `).join("");
    }

    async function loadTechnicians() {
        const res = await fetch("http://localhost:3000/api/technicians");
        const data = await res.json();
        techSelect.innerHTML = data.map(t =>
            `<option value="${t.full_name}">${t.full_name}</option>`
        ).join("");
    }

    async function loadAssets() {
        const res = await fetch("http://localhost:3000/api/assets");
        const data = await res.json();
        assetTableBody.innerHTML = data.map(a => `
            <tr>
                <td>${a.asset_name}</td>
                <td>${a.asset_type}</td>
                <td>${a.location}</td>
                <td>${a.status}</td>
                <td>${a.next_maintenance ? new Date(a.next_maintenance).toLocaleDateString() : "-"}</td>
            </tr>
        `).join("");
    }

    function logout() {
        localStorage.clear();
        window.location.href = "adminlogin.html";
    }
</script>
</body>
</html>
